name: Unlimited RDP + Tailscale + RustDesk (Self-Hosted)

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:     { description: "Tailscale tailnet", required: true }
      ts_authkey:     { description: "Tailscale auth key", required: true }
      rdp_user:       { description: "RDP username", required: false, default: "BulletUser" }
      rdp_pass:       { description: "RDP password", required: false, default: "Bullet@12345" }

jobs:
  unlimited-rdp:
    runs-on: self-hosted

    steps:
      - name: Setup RDP user
        shell: pwsh
        run: |
          $u="${{ inputs.rdp_user }}"
          $p="${{ inputs.rdp_pass }}"
          $sec = ConvertTo-SecureString $p -AsPlainText -Force
          if (-not (Get-LocalUser -Name $u -EA SilentlyContinue)) {
            New-LocalUser -Name $u -Password $sec -AccountNeverExpires
            Add-LocalGroupMember -Group "Administrators" -Member $u
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $u
          }
          Set-ItemProperty "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "RDP enabled → User: $u | Pass: $p"

      - name: Install Tailscale
        shell: pwsh
        run: |
          $ts = "$env:ProgramFiles\Tailscale\tailscale.exe"
          if (-not (Test-Path $ts)) {
            $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
            $msi = "$env:TEMP\ts.msi"
            Invoke-WebRequest $url -OutFile $msi
            Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet" -Wait
            Remove-Item $msi -Force
          }
          & $ts up --authkey "${{ inputs.ts_authkey }}" --hostname "bullet-unlimited"

      - name: Install RustDesk
        shell: pwsh
        run: |
          if (-not (Test-Path "C:\Program Files\RustDesk\rustdesk.exe")) {
            winget install RustDesk.RustDesk -e --silent --accept-source-agreements --accept-package-agreements
          }
          Start-Process "C:\Program Files\RustDesk\rustdesk.exe"

      - name: RDP + RustDesk Unlimited
        shell: pwsh
        run: |
          Write-Host "RDP + RustDesk running with NO TIME LIMIT."
          while ($true) {
            Start-Sleep -Seconds 60
            Write-Host "Alive → $(Get-Date)"
          }
